import sys
import os
import requests
import time
import json

module_path = os.path.dirname(os.path.abspath(sys.modules[__name__].__file__))
SAMPLE_PATH = os.path.join(module_path, "samples")

class VirusTotal():
    def __init__(self,apikey):
        self.apikey = apikey
        self.threshold = 0.8
    
    def send(self, file_name):
        url = "https://www.virustotal.com/api/v3/files"
        headers = {
            "accept": "application/json",
            "x-apikey": self.apikey
           
        }

        files = { "file": (file_name, open(os.path.join(SAMPLE_PATH, file_name),"rb"), "application/octet-stream") }
  
        response = requests.post(url, files=files, headers=headers)
        data = json.loads(response.text)
        return data['data']['links']['self']

    def get(self,link):
       

        headers = {
            "accept": "application/json",
            "x-apikey": self.apikey
        }

        response = requests.get(link, headers=headers)

        return response.text
    def file_report(self, file_name):
        try:
            url = self.send(file_name)
            time.sleep(2)
            while True:
                report = self.get(url)
                report = json.loads(report)
                if report['data']['attributes']['status'] == "completed":
                    bad = int(report['data']['attributes']['stats']['malicious']) + int(report['data']['attributes']['stats']['suspicious'])
                    good = int(report['data']['attributes']['stats']['undetected']) + int(report['data']['attributes']['stats']['harmless'])
                    total = bad + good 
                    return bad/total
                else:
                    time.sleep(1)
        except:
            print(f"Error in file {file_name}")